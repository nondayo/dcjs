let experiments = [{
        "Expt": 1,
        "Run": 1,
        "Speed": 850
    },
    {
        "Expt": 1,
        "Run": 2,
        "Speed": 740
    },
    {
        "Expt": 1,
        "Run": 3,
        "Speed": 900
    },
    {
        "Expt": 1,
        "Run": 4,
        "Speed": 1070
    },
    {
        "Expt": 1,
        "Run": 5,
        "Speed": 930
    },
    {
        "Expt": 1,
        "Run": 6,
        "Speed": 850
    },
    {
        "Expt": 1,
        "Run": 7,
        "Speed": 950
    },
    {
        "Expt": 1,
        "Run": 8,
        "Speed": 980
    },
    {
        "Expt": 1,
        "Run": 9,
        "Speed": 980
    },
    {
        "Expt": 1,
        "Run": 10,
        "Speed": 880
    },
    {
        "Expt": 1,
        "Run": 11,
        "Speed": 1000
    },
    {
        "Expt": 1,
        "Run": 12,
        "Speed": 980
    },
    {
        "Expt": 1,
        "Run": 13,
        "Speed": 930
    },
    {
        "Expt": 1,
        "Run": 14,
        "Speed": 650
    },
    {
        "Expt": 1,
        "Run": 15,
        "Speed": 760
    },
    {
        "Expt": 1,
        "Run": 16,
        "Speed": 810
    },
    {
        "Expt": 1,
        "Run": 17,
        "Speed": 1000
    },
    {
        "Expt": 1,
        "Run": 18,
        "Speed": 1000
    },
    {
        "Expt": 1,
        "Run": 19,
        "Speed": 960
    },
    {
        "Expt": 1,
        "Run": 20,
        "Speed": 960
    },
    {
        "Expt": 2,
        "Run": 1,
        "Speed": 960
    },
    {
        "Expt": 2,
        "Run": 2,
        "Speed": 940
    },
    {
        "Expt": 2,
        "Run": 3,
        "Speed": 960
    },
    {
        "Expt": 2,
        "Run": 4,
        "Speed": 940
    },
    {
        "Expt": 2,
        "Run": 5,
        "Speed": 880
    },
    {
        "Expt": 2,
        "Run": 6,
        "Speed": 800
    },
    {
        "Expt": 2,
        "Run": 7,
        "Speed": 850
    },
    {
        "Expt": 2,
        "Run": 8,
        "Speed": 880
    },
    {
        "Expt": 2,
        "Run": 9,
        "Speed": 900
    },
    {
        "Expt": 2,
        "Run": 10,
        "Speed": 840
    },
    {
        "Expt": 2,
        "Run": 11,
        "Speed": 830
    },
    {
        "Expt": 2,
        "Run": 12,
        "Speed": 790
    },
    {
        "Expt": 2,
        "Run": 13,
        "Speed": 810
    },
    {
        "Expt": 2,
        "Run": 14,
        "Speed": 880
    },
    {
        "Expt": 2,
        "Run": 15,
        "Speed": 880
    },
    {
        "Expt": 2,
        "Run": 16,
        "Speed": 830
    },
    {
        "Expt": 2,
        "Run": 17,
        "Speed": 800
    },
    {
        "Expt": 2,
        "Run": 18,
        "Speed": 790
    },
    {
        "Expt": 2,
        "Run": 19,
        "Speed": 760
    },
    {
        "Expt": 2,
        "Run": 20,
        "Speed": 800
    },
    {
        "Expt": 3,
        "Run": 1,
        "Speed": 880
    },
    {
        "Expt": 3,
        "Run": 2,
        "Speed": 880
    },
    {
        "Expt": 3,
        "Run": 3,
        "Speed": 880
    },
    {
        "Expt": 3,
        "Run": 4,
        "Speed": 860
    },
    {
        "Expt": 3,
        "Run": 5,
        "Speed": 720
    },
    {
        "Expt": 3,
        "Run": 6,
        "Speed": 720
    },
    {
        "Expt": 3,
        "Run": 7,
        "Speed": 620
    },
    {
        "Expt": 3,
        "Run": 8,
        "Speed": 860
    },
    {
        "Expt": 3,
        "Run": 9,
        "Speed": 970
    },
    {
        "Expt": 3,
        "Run": 10,
        "Speed": 950
    },
    {
        "Expt": 3,
        "Run": 11,
        "Speed": 880
    },
    {
        "Expt": 3,
        "Run": 12,
        "Speed": 910
    },
    {
        "Expt": 3,
        "Run": 13,
        "Speed": 850
    },
    {
        "Expt": 3,
        "Run": 14,
        "Speed": 870
    },
    {
        "Expt": 3,
        "Run": 15,
        "Speed": 840
    },
    {
        "Expt": 3,
        "Run": 16,
        "Speed": 840
    },
    {
        "Expt": 3,
        "Run": 17,
        "Speed": 850
    },
    {
        "Expt": 3,
        "Run": 18,
        "Speed": 840
    },
    {
        "Expt": 3,
        "Run": 19,
        "Speed": 840
    },
    {
        "Expt": 3,
        "Run": 20,
        "Speed": 840
    },
    {
        "Expt": 4,
        "Run": 1,
        "Speed": 890
    },
    {
        "Expt": 4,
        "Run": 2,
        "Speed": 810
    },
    {
        "Expt": 4,
        "Run": 3,
        "Speed": 810
    },
    {
        "Expt": 4,
        "Run": 4,
        "Speed": 820
    },
    {
        "Expt": 4,
        "Run": 5,
        "Speed": 800
    },
    {
        "Expt": 4,
        "Run": 6,
        "Speed": 770
    },
    {
        "Expt": 4,
        "Run": 7,
        "Speed": 760
    },
    {
        "Expt": 4,
        "Run": 8,
        "Speed": 740
    },
    {
        "Expt": 4,
        "Run": 9,
        "Speed": 750
    },
    {
        "Expt": 4,
        "Run": 10,
        "Speed": 760
    },
    {
        "Expt": 4,
        "Run": 11,
        "Speed": 910
    },
    {
        "Expt": 4,
        "Run": 12,
        "Speed": 920
    },
    {
        "Expt": 4,
        "Run": 13,
        "Speed": 890
    },
    {
        "Expt": 4,
        "Run": 14,
        "Speed": 860
    },
    {
        "Expt": 4,
        "Run": 15,
        "Speed": 880
    },
    {
        "Expt": 4,
        "Run": 16,
        "Speed": 720
    },
    {
        "Expt": 4,
        "Run": 17,
        "Speed": 840
    },
    {
        "Expt": 4,
        "Run": 18,
        "Speed": 850
    },
    {
        "Expt": 4,
        "Run": 19,
        "Speed": 850
    },
    {
        "Expt": 4,
        "Run": 20,
        "Speed": 780
    },
    {
        "Expt": 5,
        "Run": 1,
        "Speed": 890
    },
    {
        "Expt": 5,
        "Run": 2,
        "Speed": 840
    },
    {
        "Expt": 5,
        "Run": 3,
        "Speed": 780
    },
    {
        "Expt": 5,
        "Run": 4,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 5,
        "Speed": 760
    },
    {
        "Expt": 5,
        "Run": 6,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 7,
        "Speed": 790
    },
    {
        "Expt": 5,
        "Run": 8,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 9,
        "Speed": 820
    },
    {
        "Expt": 5,
        "Run": 10,
        "Speed": 850
    },
    {
        "Expt": 5,
        "Run": 11,
        "Speed": 870
    },
    {
        "Expt": 5,
        "Run": 12,
        "Speed": 870
    },
    {
        "Expt": 5,
        "Run": 13,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 14,
        "Speed": 740
    },
    {
        "Expt": 5,
        "Run": 15,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 16,
        "Speed": 940
    },
    {
        "Expt": 5,
        "Run": 17,
        "Speed": 950
    },
    {
        "Expt": 5,
        "Run": 18,
        "Speed": 800
    },
    {
        "Expt": 5,
        "Run": 19,
        "Speed": 810
    },
    {
        "Expt": 5,
        "Run": 20,
        "Speed": 870
    }
]
var chart = dc.dataTable("#test");
var piechart = dc.pieChart("#piechart");
var ndx;
d3.csv("morley.csv").then(function (experiments) {
            ndx = crossfilter(experiments);
            var fmt = d3.format('02d');
            var runDimension = ndx.dimension(function (d) {
                    return [fmt(+d.Expt), fmt(+d.Run)];
                }),
                experimentDimension = ndx.dimension(function (d) {
                    return d.Expt;
                }),
                grouping = function (d) {
                    return d.Expt;
                },
                experimentGroup = experimentDimension.group().reduceCount();
            piechart.width(300).height(280)
                .innerRadius(100).externalLabels(50).externalRadiusPadding(50).drawPaths(true)
                .dimension(experimentDimension).group(experimentGroup)
                .legend(dc.legend())
                .controlsUseVisibility(true);
            chart
                .width(300)
                .height(480)
                .dimension(runDimension)
                .group(grouping)
                .size(Infinity)
                .showGroups(false)
                .columns(['Expt', 'Run', 'Speed'])
                .sortBy(function (d) {
                    return [fmt(+d.Expt), fmt(+d.Run)];
                })
                .order(d3.ascending)
                .on('preRender', update_offset)
                .on('preRedraw', update_offset)
                .on('pretransition', display);
            dc.renderAll();
            // });
            // use odd page size to show the effect better
            var ofs = 0,
                pag = 17;

            function update_offset() {
                var totFilteredRecs = ndx.groupAll().value();
                var end = ofs + pag > totFilteredRecs ? totFilteredRecs : ofs + pag;
                ofs = ofs >= totFilteredRecs ? Math.floor((totFilteredRecs - 1) / pag) * pag : ofs;
                ofs = ofs < 0 ? 0 : ofs;
                chart.beginSlice(ofs);
                chart.endSlice(ofs + pag);
            }

            function display() {
                var totFilteredRecs = ndx.groupAll().value();
                var end = ofs + pag > totFilteredRecs ? totFilteredRecs : ofs + pag;
                d3.select('#begin')
                    .text(end === 0 ? ofs : ofs + 1);
                d3.select('#end')
                    .text(end);
                d3.select('#last')
                    .attr('disabled', ofs - pag < 0 ? 'true' : null);
                d3.select('#next')
                    .attr('disabled', ofs + pag >= totFilteredRecs ? 'true' : null);
                d3.select('#size').text(totFilteredRecs);
                if (totFilteredRecs != ndx.size()) {
                    d3.select('#totalsize').text("(filtered Total: " + ndx.size() + " )");
                } else {
                    d3.select('#totalsize').text('');
                }
            }

            function next() {
                ofs += pag;
                update_offset();
                chart.redraw();
            }

            function last() {
                ofs -= pag;
                update_offset();
                chart.redraw();
            }